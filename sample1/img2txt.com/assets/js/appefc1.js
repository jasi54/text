"use strict";var Template=window.Template||{},Msg=window.Msg||{};$(function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$('[data-page="ocr-results-image"]').length&&App.OcrResult.init(),$('[data-page="ocr-results-pdf"]').length&&App.PdfResult.init(),App.init(),App.OcrUpload.init(),$('[data-page="ocr-my-results"]').length&&App.OcrMy.init()}),App={max_try:36,i_try:0,getQueuePosition:function(){var e=$(".q_position");App.i_try++,App.i_try>=App.max_try?swal({icon:"error",text:"Unable to get results :("}):(e.data("fprocessing")&&App.updateHref(e.data("fprocessing")),$.ajax({dataType:"json",url:e.data("url"),success:function(t){if("queued"===t.status){$(e).find("span").text(t.position);var a=100/parseInt(t.position);$(e).find(".bar").width(a+"%"),setTimeout(function(){App.getQueuePosition()},5e3)}else if("ready"===t.status){$(e).find("span").text("0 (processing)"),$(e).find(".bar").width("100%").addClass("bar-success");var s=Math.floor(8*Math.random())+3;if(t.run>s)e.data("fprocessing")?window.location.href=e.data("fprocessing"):location.reload();else{var o=s-t.run;setTimeout(function(){e.data("fprocessing")?window.location.href=e.data("fprocessing"):location.reload()},1e3*o)}}else if("processing"===t.status)$(e).find("span").text("0 (processing)"),$(e).find(".bar").width("100%").addClass("bar-success"),setTimeout(function(){App.getQueuePosition()},5e3);else{s=Math.floor(6*Math.random())+15;if(t.run>s)e.data("fprocessing")?window.location.href=e.data("fprocessing"):location.reload();else{o=s-t.run;setTimeout(function(){e.data("fprocessing")?window.location.href=e.data("fprocessing"):location.reload()},1e3*o)}}}}))},updateHref:function(e){setTimeout(function(){window.history.pushState("page2","Title",e)},500)},_detectAB:function(){if($(".adsbygoogle").length){var e=Cookies.get("DetectAB");!1===$(".adsbygoogle").is(":visible")&&(void 0===e&&Template.UI.ShowAlert("#tab-file","<p>"+Msg.tpl_adblock+"</p>","danger"),App._initGB())}},_initGB:function(){var e="";e=0===Math.floor(2*Math.random())?'<a href="https://bit.ly/img2txt_ali_cool" rel="nofollow" target="_blank"><img src="/tmp/ali_cool_725x90.jpg" alt="" title="Крутые девайсы на Али, до 5$" /></a>':'<a href="https://bit.ly/img2txt_ali_best" rel="nofollow" target="_blank"><img src="/tmp/ali_best_month_725_90.png" alt="" title="Лучшая цена месяца на Али" /></a>',$(".aFormat_mainAdapt").length&&($(".aFormat_mainAdapt").after(e),$(".aFormat_mainAdapt").closest(".static-image").css("margin-top","30px")),$(".aFormat_myOCRList").length&&$(".aFormat_myOCRList").after(e),$(".aFormat_processing").length&&$(".aFormat_processing").after(e),$(".aFormat_resPDFHorizont").length&&$(".aFormat_resPDFHorizont").after(e)},getLang:function(){return $("html").attr("lang")},_privacy:function(){window.cookieconsent.initialise({palette:{popup:{background:"#000"},button:{background:"#f1d600"}},theme:"edgeless",content:{message:Msg.our_ws_cook,dismiss:"OK",link:Msg.our_ws_cook_more,href:"/privacy"}})},init:function(){this._privacy(),this._detectAB(),$(".q_position").length&&App.getQueuePosition()}},App.Forms={ajaxRequestDeferred:function(e={}){var t=new $.Deferred,a={type:"post",dataType:"json",timeout:1e4};for(var s in $.isEmptyObject(e)&&t.reject("Empty ajaxArgs in ajaxRequstDeferred!"),e)a[s]=e[s];return $.ajax(a).done(function(e){"JSON"===a.dataType.toUpperCase()&&"success"in e&&("false"===e.success||!1===e.success)?t.reject(e):t.resolve(e)}).fail(function(e,a,s){422===e.status&&e.responseJSON?t.reject({title:"Ошибка",errors:e.responseJSON.errors}):t.reject({title:"Ошибка",error:s})}),t}},App.OcrUpload={_file:function(){$(".dropzone2").dropzone({url:"/"+App.getLang()+"/file/upload-dropdown",maxFiles:1,maxFilesize:8,createImageThumbnails:!1,acceptedFiles:"image/jpeg, image/png, application/pdf",dictFileTooBig:Msg.dzFileTooBig,headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},success:function(e,t){if($(".dropzone2 .dz-preview").hide(),$(".dropzone2 .dz-success").length||$(".dropzone2").append('<div class="dz-success"></div>'),!0===t.success){$('.dropzone2 [name="fHash"]').length?($('.dropzone2 [name="fHash"]').val(t.hash),$('.dropzone2 [name="fName"]').val(t.fname)):($(".dropzone2").append('<input type="hidden" name="fHash" value="'+t.hash+'" />'),$(".dropzone2").append('<input type="hidden" name="fName" value="'+t.fname+'" />'));var a='<div class="img-block"><img src="/assets/i/upload_ok.png" alt="" /></div><div class="text"><h4>'+t.title+"</h4>"+t.msg+"</div>"}else{a='<div class="img-block"><img src="/assets/i/upload_error.png" alt="" /></div><div class="text">';$.each(t.errors,function(e,t){a+=t.join("<br />")}),a+="</div>"}t.html=a,$(".dropzone2 .dz-success").html(t.html),this.files=[]},error:function(e,t){this.removeFile(e),$(".dropzone2 .dz-success").length&&$(".dropzone2 .dz-success").html(),swal({icon:"error",text:t})},init:function(){var e=this;document.onpaste=function(t){var a=(t.clipboardData||t.originalEvent.clipboardData).items;for(var s in a){var o=a[s];"file"===o.kind&&e.addFile(o.getAsFile())}}}})},init:function(){this._file()}},App.OcrMy={_bindRemoveRequest:function(){$(".remove-request, .requests-all-remove").click(function(e){e.preventDefault();var t=$(this).data("id");swal({title:Msg.are_you_sure,icon:"warning",buttons:!0,dangerMode:!0}).then(e=>{if(e){var a={url:$('[data-page="ocr-my-results"]').data("url"),data:{id:t}};App.Forms.ajaxRequestDeferred(a).done(function(e){!0===data.success?($("#task_"+t).fadeTo("slow",.7,function(){$(this).remove()}),swal({icon:"success",text:Msg.action_s_complite,buttons:!1,timer:1500}),data.refresh&&setTimeout(function(){location.reload()},1e3)):swal({title:Msg.action_went_wrong,icon:"error"})}).fail(function(e){alert("Backend error =(")})}})})},init:function(){this._bindRemoveRequest()}},App.PdfResult={updateHref:function(){$(".results-pdf").data("fprocessing")&&App.updateHref($(".results-pdf").data("fprocessing"))},init:function(){this.updateHref()}},App.OcrResult={_translateLink:function(){$('.results-links a[href="#nav_translate"]').click(function(){var e=$(".result"),t="http://translate.google.com/translate?sl="+e.data("lang");t+="&tl="+App.getLang(),t+="&u="+encodeURIComponent(e.data("raw")),$(this).attr("href",t).attr("target","_blank").off()})},_orfoRequest:function(){$('.results-links a[href="#nav_orfo"]').click(function(){var e=$(".result"),t="https://www.online-spellcheck.com/spell-check-url";t+="?download_url="+encodeURIComponent(e.data("raw")),$(this).attr("href",t).attr("target","_blank").off()})},_gDocsRequest:function(){$('.results-links a[href="#nav_google_docs"]').click(function(){var e=$(".result"),t="http://docs.google.com/viewer";t+="?url="+encodeURIComponent(e.data("raw")),$(this).attr("href",t).attr("target","_blank").off()})},_saveTextRequest:function(){$(".results-text textarea").bind("keyup change",function(){$(".gtm_saveEdit").hasClass("opacity")&&$(".gtm_saveEdit").removeClass("opacity")}),$('.results-links a[href="#nav_save_res"]').click(function(e){e.preventDefault();var t=$(this),a=$(".result"),s=$(".results-text textarea").val(),o={url:$(".main-logo a").attr("href")+"/file/"+a.data("hash")+"/save-text/"+a.data("id"),data:{text:s}};App.Forms.ajaxRequestDeferred(o).done(function(e){t.addClass("opacity")}).fail(function(e){alert("Backend error =(")})})},_copyResult:function(){$('.results-links a[href="#nav_copyResult"]').click(function(e){e.preventDefault();var t=$("<textarea>"),a=$(".results-text textarea").val();$("body").append(t),a=a.trim(),t.val(a).select();try{document.execCommand("copy")?swal({icon:"success",text:Msg.result_copied,buttons:!1,timer:1e3}):swal({icon:"error",text:"Unable to copy"}),t.remove()}catch(e){swal({icon:"error",text:"Unsupported Browser!"}),t.remove()}})},updateHref:function(){$(".results-text").data("fprocessing")&&App.updateHref($(".results-text").data("fprocessing"))},init:function(){this._copyResult(),this._orfoRequest(),this._translateLink(),this._gDocsRequest(),this._saveTextRequest(),this.updateHref()}};
